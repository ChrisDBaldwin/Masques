{"id":"masques-0py","title":"Make accounts.balance a MATERIALIZED column","description":"The `accounts.balance` column is a plain Decimal128(18) that must be manually computed on insert. This is a foot-gun — if the snapshot writer computes it wrong, analytics silently diverge from TigerBeetle truth. Change to: `balance Decimal128(18) MATERIALIZED credits_posted - debits_posted`. This ensures ClickHouse computes it on insert automatically. Affects sql/003_ledger.sql.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-02-06T21:53:54.44928-06:00","created_by":"chris","updated_at":"2026-02-06T22:54:16.686633-06:00","closed_at":"2026-02-06T22:54:16.686633-06:00","close_reason":"MATERIALIZED balance column added to sql/003_ledger.sql"}
{"id":"masques-2e9","title":"Enable Claude Code native OTEL → ironwood ClickHouse","description":"## Goal\n\nRoute Claude Code's native telemetry to homelab ClickHouse on ironwood.\n\n## Steps\n\n1. Enable telemetry:\n   ```bash\n   export CLAUDE_CODE_ENABLE_TELEMETRY=1\n   export OTEL_EXPORTER_OTLP_ENDPOINT=http://ironwood:4317\n   ```\n\n2. Set up OTEL collector on ironwood (if not already)\n   - Receive OTLP\n   - Export to ClickHouse\n\n3. Create ClickHouse tables for Claude Code telemetry\n   - Sessions\n   - Tool executions\n   - Token usage\n   - Costs\n\n4. Verify data flowing\n\n## References\n\n- https://github.com/ColeMurray/claude-code-otel\n- Existing opengander OTEL → ClickHouse patterns\n\n## Acceptance\n\n- [ ] Telemetry enabled in shell profile\n- [ ] Collector receiving data\n- [ ] ClickHouse tables created\n- [ ] Can query session/tool data","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-04T20:34:34.766123-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:34.766123-06:00"}
{"id":"masques-2ne","title":"Scaffold masques MCP server with FastMCP","description":"## Overview\n\nCreate a standalone MCP server for masques runtime functionality, following opengander patterns.\n\n## Structure\n\n```\nservices/mcp-server/\n├── src/masques_mcp/\n│   ├── server.py           # FastMCP app, tool registration\n│   ├── config.py           # Pydantic settings (masque paths, etc.)\n│   ├── session.py          # Session state management\n│   ├── loader.py           # YAML masque file loading\n│   └── tools/\n│       ├── __init__.py\n│       ├── _common.py      # Shared utilities\n│       ├── session.py      # don/doff/identity tools\n│       ├── intent.py       # Intent pattern matching\n│       ├── knowledge.py    # Knowledge resolution\n│       └── access.py       # Ring/permission checks\n├── tests/\n├── pyproject.toml\n└── README.md\n```\n\n## Key Decisions\n\n- **Python + FastMCP** (same as opengander)\n- **File-based session state** (YAML, same location as current)\n- **Reads masque YAMLs** from ~/.masques/ and bundled personas/\n\n## Acceptance\n\n- [ ] pyproject.toml with fastmcp, pydantic deps\n- [ ] Basic server.py with health check\n- [ ] Config loading from env vars\n- [ ] Masque YAML loader\n- [ ] Can run locally: `uv run masques-mcp`","notes":"Not needed - Claude Code has native OTEL, no custom server required","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-04T19:39:49.326795-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:25.890757-06:00","closed_at":"2026-02-04T20:34:25.890764-06:00"}
{"id":"masques-50p","title":"Design TigerBeetle → ClickHouse sync service","description":"The ClickHouse schema has accounts (balance snapshots) and transactions (payment event log) tables ready, but nothing writes to them. Need a sync service that: (1) periodically snapshots TigerBeetle account balances → masques.accounts, (2) streams TigerBeetle transfers → masques.transactions with two-phase status tracking (pending/posted/voided). Design questions: polling vs event-driven, sync frequency, what runtime (sidecar? cron? dedicated service?). This is the critical bridge between ledger-of-record and analytics. Blocked until TigerBeetle integration begins.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-06T21:54:05.403379-06:00","created_by":"chris","updated_at":"2026-02-06T21:54:05.403379-06:00"}
{"id":"masques-599","title":"Migrate slash commands to MCP tool wrappers","description":"## Overview\n\nOnce MCP server is working, slash commands become thin wrappers that call MCP tools.\n\n## Mapping\n\n| Command | MCP Tool |\n|---------|----------|\n| /don \u003cname\u003e | don_masque(name) |\n| /doff | doff_masque() |\n| /id | get_identity() |\n| /list | list_masques() |\n| /inspect | get_identity() + get_intent_boundaries() |\n\n## Benefits\n\n- Commands just format MCP responses for display\n- All logic lives in MCP server\n- Can use MCP tools directly without commands\n- Easier testing (test MCP tools, not markdown instructions)\n\n## Migration Steps\n\n1. Update each command/*.md to call MCP tool\n2. Format response for terminal display\n3. Remove duplicated logic from commands\n4. Test both command and direct MCP usage\n\n## Example: /don becomes\n\n```markdown\n1. Call MCP tool: don_masque(name=\u003cname\u003e)\n2. If success, display:\n   ✓ Donned {name} v{version}\n   Ring: {ring}\n   {tagline}\n3. If activates present, suggest invoking skills\n4. If error, display error message\n```\n\n## Acceptance\n\n- [ ] All commands use MCP tools\n- [ ] Commands are display logic only\n- [ ] Direct MCP tool usage works\n- [ ] /sync-manifest removed (list_masques generates fresh)","notes":"Commands stay as-is, no MCP to wrap","status":"closed","priority":2,"issue_type":"chore","created_at":"2026-02-04T19:41:11.26753-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:26.087316-06:00","closed_at":"2026-02-04T20:34:26.087319-06:00","dependencies":[{"issue_id":"masques-599","depends_on_id":"masques-joh","type":"blocks","created_at":"2026-02-04T19:41:21.007699-06:00","created_by":"chris"}]}
{"id":"masques-5yn","title":"Simplify schema: remove unused fields","description":"## Problem\n\nThe schema has many fields that aren't used:\n- `ring` (admin/player/guest/outsider) - never enforced\n- `performance` - never collected\n- `index` - unclear purpose, maybe for ordering?\n\nThese add complexity without value.\n\n## Proposed Removals\n\n| Field | Reason |\n|-------|--------|\n| ring | Not enforced, remove or implement |\n| performance | Remove until Witness works |\n| index | Remove if only for ordering (use name sort) |\n\n## Keep (working)\n\n- name, version (identity)\n- lens, context (prompt injection)\n- spinnerVerbs (UX)\n- attributes (metadata)\n\n## Acceptance\n\n- [ ] Audit each field for actual usage\n- [ ] Remove unused fields from schema\n- [ ] Update existing masques\n- [ ] Simplify documentation","status":"closed","priority":1,"issue_type":"chore","created_at":"2026-02-04T19:26:02.282191-06:00","created_by":"chris","updated_at":"2026-02-04T21:39:42.429234-06:00","closed_at":"2026-02-04T21:39:42.429234-06:00","close_reason":"Schema simplified: removed index, ring, intent, knowledge, access, skills, mcp, performance. Kept name, version, lens (required), context, attributes, spinnerVerbs (optional)."}
{"id":"masques-7d2","title":"Evaluate transactions ORDER BY for account-first access patterns","description":"The transactions table uses ORDER BY (timestamp, transaction_id). Most dashboard queries will filter by account — 'show all transactions for account X' — which scans every granule with the current key. Options: (1) change ORDER BY to (debit_account_id, timestamp, transaction_id), (2) add a projection for account-first access, (3) keep current if time-range scans dominate. Decision depends on actual query patterns once TigerBeetle sync is flowing. Revisit when the sync service exists. Affects sql/003_ledger.sql.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-06T21:53:55.456004-06:00","created_by":"chris","updated_at":"2026-02-06T21:53:55.456004-06:00","dependencies":[{"issue_id":"masques-7d2","depends_on_id":"masques-50p","type":"blocks","created_at":"2026-02-06T21:54:13.069595-06:00","created_by":"chris"}]}
{"id":"masques-7fe","title":"Auto-sync manifests on /list","description":"## Problem\n\nUsers must manually run `/sync-manifest` after adding masques. If they forget, `/list` shows stale data or prompts them to sync.\n\n## Proposal\n\nMake `/list` smart:\n1. Check manifest mtime vs newest masque file mtime\n2. If stale, auto-regenerate manifest\n3. Then display\n\n## Trade-offs\n\n**Pro**: One less command, always fresh data\n**Con**: Slight latency on first `/list` after changes\n\n## Alternative\n\nRemove manifests entirely - just glob and parse on every `/list`. With \u003c20 masques, this is fast enough.\n\n## Acceptance\n\n- [ ] Implement freshness check in /list\n- [ ] Auto-regenerate if stale\n- [ ] Consider removing /sync-manifest command","notes":"list_masques MCP tool will always return fresh data","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-04T19:26:10.0208-06:00","created_by":"chris","updated_at":"2026-02-04T19:41:32.593561-06:00","closed_at":"2026-02-04T19:41:32.593564-06:00"}
{"id":"masques-952","title":"Implement Witness evaluation tools","description":"## Tools\n\n### evaluate_session(session_transcript: str) -\u003e dict\n- Takes session transcript (or summary)\n- Scores masque-task alignment 0-100\n- Considers: Did agent embody lens? Respect intent boundaries? Use knowledge appropriately?\n- Returns: {score: int, assessment: str, recommendations: [str]}\n\n### record_performance(score: int, notes: str) -\u003e dict\n- Append to masque's performance history\n- Write to ~/.masques/performances/{masque}-{timestamp}.yaml\n- Update masque's performance.score aggregation\n\n### get_performance_history(masque_name: str) -\u003e dict\n- Return historical performance records\n- Useful for tracking masque effectiveness over time\n\n## Scoring Rubric\n\n| Score | Meaning |\n|-------|---------|\n| 90-100 | Exemplary - fully embodied masque |\n| 70-89 | Good - mostly aligned |\n| 50-69 | Mixed - some drift from identity |\n| 30-49 | Poor - significant misalignment |\n| 0-29 | Failed - ignored masque entirely |\n\n## Integration Options\n\n1. **Manual**: Agent calls evaluate_session at end of task\n2. **Hook-triggered**: Claude Code PreStop hook triggers evaluation\n3. **Sampling**: Evaluate random subset of sessions\n\nStart with manual, add hooks later.\n\n## Acceptance\n\n- [ ] evaluate_session with scoring logic\n- [ ] record_performance persists history\n- [ ] get_performance_history retrieves records\n- [ ] Performance file format defined","notes":"Witness becomes trace analyzer, not MCP tool","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-04T19:41:00.085903-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:26.060342-06:00","closed_at":"2026-02-04T20:34:26.060345-06:00","dependencies":[{"issue_id":"masques-952","depends_on_id":"masques-joh","type":"blocks","created_at":"2026-02-04T19:41:11.231272-06:00","created_by":"chris"}]}
{"id":"masques-a7f","title":"Decide: MCP knowledge URIs - remove, realize, or transform","description":"## Problem\n\nThe `knowledge:` field declares MCP URIs like `mcp://zig/stdlib` that are never queried. Firekeeper even admits: \"These MCP resources are planned but not yet deployed.\"\n\n## Options\n\n1. **Remove** - Cut the field entirely. Lens can just say \"look up X docs when needed\"\n2. **Realize** - Connect to Context7 or similar MCP servers at `/don` time\n3. **Transform** - Change to context file includes that get injected when donned\n\n## Recommendation\n\nOption 3 seems most practical - actual files bundled with masques that provide domain context, not pointers to imaginary servers.\n\n## Acceptance\n\n- [ ] Decide which option\n- [ ] Implement or remove\n- [ ] Update schema\n- [ ] Update existing masques","notes":"Superseded by masques-aia (MCP-based knowledge resolution)","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-04T19:25:24.085454-06:00","created_by":"chris","updated_at":"2026-02-04T19:41:32.53823-06:00","closed_at":"2026-02-04T19:41:32.538232-06:00"}
{"id":"masques-aia","title":"Implement knowledge resolution tools","description":"## Tools\n\n### resolve_knowledge(uri: str) -\u003e dict\n- Parse mcp:// URI\n- Route to appropriate source:\n  - Local files: `mcp://local/path/to/file.md`\n  - Bundled context: `mcp://masques/context/zig-stdlib.md`\n  - External MCP: `mcp://context7/zig/stdlib` (delegate)\n- Return content or error\n\n### list_knowledge() -\u003e dict\n- Return knowledge URIs declared by active masque\n- Include resolution status (available/unavailable)\n\n## URI Routing Strategy\n\n1. **Local files**: `mcp://local/...` → read from filesystem\n2. **Bundled**: `mcp://masques/...` → read from plugin context/ directory\n3. **External**: `mcp://context7/...` → call Context7 MCP server\n4. **Unavailable**: Return helpful error with alternatives\n\n## Context Bundling\n\nMasques can bundle context files:\n```\n~/.masques/\n├── context/\n│   ├── zig-stdlib-summary.md\n│   └── my-project-arch.md\n├── codesmith.masque.yaml  # references mcp://local/context/zig-stdlib-summary.md\n```\n\n## Acceptance\n\n- [ ] resolve_knowledge tool works for local files\n- [ ] Bundled context directory support\n- [ ] Graceful fallback when unavailable\n- [ ] list_knowledge shows what's declared vs available","notes":"Knowledge resolution not needed in MCP approach","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-04T19:40:28.642008-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:25.978511-06:00","closed_at":"2026-02-04T20:34:25.978513-06:00","dependencies":[{"issue_id":"masques-aia","depends_on_id":"masques-joh","type":"blocks","created_at":"2026-02-04T19:40:38.431991-06:00","created_by":"chris"}]}
{"id":"masques-b16","title":"Remove or implement access/vault credentials","description":"## Problem\n\nThe `access:` field declares vault roles and credential needs:\n```yaml\naccess:\n  vault_role: opengander-dba\n  ttl: session\n  credentials:\n    - source: aws-secrets-manager\n      scope: read-only\n```\n\nNone of this is implemented. No vault integration, no credential minting, no TTL enforcement.\n\n## Options\n\n1. **Remove** - Cut the field until there's an actual vault system to integrate with\n2. **Implement** - Build vault integration (significant scope)\n3. **Simplify** - Change to environment variable declarations that get checked at don time\n\n## Recommendation\n\nRemove for now. This is enterprise-grade infrastructure that doesn't exist yet. Can re-add when there's something to connect to.\n\n## Acceptance\n\n- [ ] Decide approach\n- [ ] Remove or implement\n- [ ] Update schema\n- [ ] Update existing masques","notes":"Superseded by masques-khb (MCP-based ring/access tools)","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-04T19:25:38.123709-06:00","created_by":"chris","updated_at":"2026-02-04T19:41:37.223831-06:00","closed_at":"2026-02-04T19:41:37.223833-06:00"}
{"id":"masques-c8y","title":"Implement Witness evaluation system","description":"## Problem\n\nThe Witness masque is fully designed but never invoked:\n- Post-session evaluation\n- Scores 0-100 on masque-task alignment\n- Writes performance files\n\nNo hook integration exists to trigger evaluation.\n\n## Design (from witness.masque.yaml)\n\n1. PreStop hook triggers Witness\n2. Witness reads session transcript\n3. Scores alignment: did agent embody masque while pursuing user intent?\n4. Writes to `~/.masques/performances/{masque}-{timestamp}.yaml`\n5. Updates `performance.history` in masque file\n\n## Implementation Needs\n\n- [ ] Claude Code hook integration (PreStop)\n- [ ] Session transcript access\n- [ ] Performance file format\n- [ ] Opt-in mechanism (not every session needs evaluation)\n\n## Recommendation\n\nThis is valuable but lower priority than core simplification. Park until the basics are solid.\n\n## Acceptance\n\n- [ ] Implement PreStop hook integration\n- [ ] Build evaluation prompt\n- [ ] Test scoring consistency\n- [ ] Add opt-in flag","notes":"Superseded by masques-952 (MCP-based Witness tools)","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-04T19:25:55.530927-06:00","created_by":"chris","updated_at":"2026-02-04T19:41:32.565029-06:00","closed_at":"2026-02-04T19:41:32.565031-06:00"}
{"id":"masques-cfv","title":"Reduce api_requests.price_usd precision from Decimal64(12) to Decimal64(6)","description":"The price_usd column uses Decimal64(12) — 12 decimal places is sub-picodollar precision. For USD API metering, Decimal64(6) gives micro-dollar granularity which is more than sufficient. The extra precision wastes storage and marginally impacts sort performance. Simple one-line fix in sql/005_metering.sql.","status":"closed","priority":4,"issue_type":"bug","created_at":"2026-02-06T21:54:06.310564-06:00","created_by":"chris","updated_at":"2026-02-06T22:54:17.790088-06:00","closed_at":"2026-02-06T22:54:17.790088-06:00","close_reason":"Reduced price_usd precision to Decimal64(6) in sql/005_metering.sql"}
{"id":"masques-cnk","title":"Consolidate session state files","description":"## Problem\n\nMasque state is split across two files:\n- `.claude/masque.session.yaml` - active masque, timestamps\n- `.claude/settings.local.json` - spinnerVerbs\n\nThis means `/don` and `/doff` must read/write both files with different formats (YAML vs JSON).\n\n## Proposal\n\nMove spinnerVerbs into session.yaml:\n```yaml\nactive:\n  name: Codesmith\n  source: shared\n  donned_at: 2026-01-26T12:00:00Z\n  spinnerVerbs:\n    mode: replace\n    verbs: [\"Forging...\", \"Tempering...\"]\n```\n\n## Trade-offs\n\n**Pro**: Single source of truth, simpler commands\n**Con**: Claude Code might expect spinnerVerbs in settings.local.json\n\n## Investigation Needed\n\nDoes Claude Code read spinnerVerbs from settings.local.json or can we put it elsewhere?\n\n## Acceptance\n\n- [ ] Investigate Claude Code spinner config\n- [ ] If possible, consolidate to single file\n- [ ] Update /don and /doff commands","notes":"Session state will be managed by MCP server, single source of truth","status":"closed","priority":3,"issue_type":"chore","created_at":"2026-02-04T19:26:18.763459-06:00","created_by":"chris","updated_at":"2026-02-04T19:41:37.252653-06:00","closed_at":"2026-02-04T19:41:37.252656-06:00"}
{"id":"masques-cpp","title":"Build Witness trace analyzer for continuous confidence","description":"## Goal\n\nWitness queries OTEL traces in ClickHouse to score masque alignment continuously.\n\n## Queries\n\n### Intent Boundary Check\n```sql\nSELECT \n  session_id,\n  masque_name,\n  tool_name,\n  -- Check if tool matches denied patterns\n  multiMatchAny(tool_name, masque_intent_denied) as violated\nFROM claude_code_traces\nWHERE masque_name IS NOT NULL\n  AND violated = 1\n```\n\n### Session Confidence Score\n```sql\nSELECT\n  session_id,\n  masque_name,\n  countIf(violated = 0) / count() * 100 as confidence_score\nFROM claude_code_traces\nWHERE masque_name IS NOT NULL\nGROUP BY session_id, masque_name\n```\n\n### Drift Detection\n- Compare tool usage patterns to masque's expected domain\n- Alert if Codesmith is doing database work, etc.\n\n## Output\n\n- Dashboard in Grafana (or custom UI)\n- Alerts when confidence drops below threshold\n- Historical trend per masque\n\n## Acceptance\n\n- [ ] Can query alignment by session\n- [ ] Confidence score calculation works\n- [ ] Drift detection identifies domain mismatch\n- [ ] Dashboard or CLI to view scores","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-04T20:34:54.529506-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:54.529506-06:00","dependencies":[{"issue_id":"masques-cpp","depends_on_id":"masques-hxr","type":"blocks","created_at":"2026-02-04T20:34:58.377596-06:00","created_by":"chris"}]}
{"id":"masques-hxr","title":"Add masque context hook to enrich OTEL spans","description":"## Goal\n\nWhen a masque is donned, enrich all OTEL spans with masque identity context.\n\n## Approach\n\nSessionStart hook reads active masque and sets span attributes:\n- masque.name\n- masque.version\n- masque.ring\n- masque.intent.allowed (patterns)\n- masque.intent.denied (patterns)\n\nOr: PostToolUse hook adds masque context to each tool span.\n\n## Hook Implementation\n\n```bash\n#!/bin/bash\n# ~/.claude/hooks/masque-context.sh\nINPUT=$(cat)\n\n# Read active masque from session file\nMASQUE=$(yq '.active.name' ~/.claude/masque.session.yaml 2\u003e/dev/null)\n\nif [ \"$MASQUE\" != \"null\" ] \u0026\u0026 [ -n \"$MASQUE\" ]; then\n  # Emit span attribute or log enrichment\n  # Details depend on how CC OTEL allows enrichment\nfi\n```\n\n## Investigation Needed\n\n- How does CC native OTEL handle custom attributes?\n- Can we inject via hooks or need collector-side enrichment?\n\n## Acceptance\n\n- [ ] Spans include masque.name when masque is active\n- [ ] Spans include masque.ring\n- [ ] Can filter/group by masque in queries","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-04T20:34:44.572506-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:44.572506-06:00","dependencies":[{"issue_id":"masques-hxr","depends_on_id":"masques-2e9","type":"blocks","created_at":"2026-02-04T20:34:54.488211-06:00","created_by":"chris"}]}
{"id":"masques-imo","title":"Implement intent enforcement tools","description":"## Tools\n\n### check_intent(action: str) -\u003e dict\n- Get active masque's intent patterns\n- Match action against allowed patterns (glob-style)\n- Match action against denied patterns\n- Return: {allowed: bool, action: str, matched_pattern: str | null, reason: str}\n\n### get_intent_boundaries() -\u003e dict\n- Return current masque's allowed/denied patterns\n- Useful for agents to self-check before acting\n\n## Pattern Matching\n\nGlob-style patterns:\n- `implement *` matches \"implement feature X\"\n- `rush *` matches \"rush the deployment\"\n- Exact matches: `drop database` matches only that\n\nDenied takes precedence over allowed.\n\n## Example\n\n```python\n# Masque has:\n# allowed: [\"implement *\", \"design *\"]\n# denied: [\"rush *\"]\n\ncheck_intent(\"implement auth feature\")\n# -\u003e {allowed: true, matched_pattern: \"implement *\"}\n\ncheck_intent(\"rush the fix\")  \n# -\u003e {allowed: false, matched_pattern: \"rush *\", reason: \"denied\"}\n\ncheck_intent(\"delete production\")\n# -\u003e {allowed: false, matched_pattern: null, reason: \"no matching allowed pattern\"}\n```\n\n## Acceptance\n\n- [ ] check_intent tool with glob matching\n- [ ] get_intent_boundaries tool\n- [ ] Denied patterns override allowed\n- [ ] Clear reasoning in response","notes":"Intent checking via Witness trace analysis, not MCP tool","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-04T19:40:18.542942-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:25.94992-06:00","closed_at":"2026-02-04T20:34:25.949922-06:00","dependencies":[{"issue_id":"masques-imo","depends_on_id":"masques-joh","type":"blocks","created_at":"2026-02-04T19:40:28.604696-06:00","created_by":"chris"}]}
{"id":"masques-irl","title":"Implement skill activation tools","description":"## Tools\n\n### get_skill_declarations() -\u003e dict\n- Return active masque's declared skills with proficiency levels\n- Format: [{uri: \"skill://domain/name\", level: \"proficient\"}, ...]\n\n### activate_skills() -\u003e dict\n- Read masque's activates: field (new schema addition)\n- Return list of Claude Code skills to invoke\n- Agent should then call those skills\n\n## Schema Addition\n\nNew field in masque YAML:\n```yaml\nactivates:\n  - compound-engineering:dhh-rails-style\n  - compound-engineering:frontend-design\n```\n\nThese are actual Claude Code skill names that get auto-invoked when masque is donned.\n\n## Workflow\n\n1. Agent calls don_masque(\"codesmith\")\n2. don_masque returns {activates: [\"skill-a\", \"skill-b\"]}\n3. Agent invokes /skill-a and /skill-b to load them\n\n## Proficiency Levels (Informational)\n\nThe skills: field with levels remains informational:\n```yaml\nskills:\n  - uri: skill://programming/zig\n    level: competent\n```\n\nThis tells the agent \"I claim competent Zig skill\" - useful for self-assessment but not enforced.\n\n## Acceptance\n\n- [ ] get_skill_declarations returns declared skills\n- [ ] activate_skills returns list of skills to invoke\n- [ ] activates: field added to schema\n- [ ] don_masque includes activates in response","notes":"Skill activation not needed - keep declarative","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-04T19:40:49.637275-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:26.033999-06:00","closed_at":"2026-02-04T20:34:26.034002-06:00","dependencies":[{"issue_id":"masques-irl","depends_on_id":"masques-joh","type":"blocks","created_at":"2026-02-04T19:41:00.048979-06:00","created_by":"chris"}]}
{"id":"masques-joh","title":"Implement session tools: don/doff/identity","description":"## Tools\n\n### don_masque(name: str, intent: str | None = None) -\u003e dict\n- Search private (~/.masques/) then shared (personas/) paths\n- Load and validate masque YAML\n- Write session state to ~/.masques/session.yaml (or .claude/)\n- Return masque summary (name, version, ring, lens preview)\n\n### doff_masque() -\u003e dict\n- Clear active masque from session\n- Move to previous\n- Return confirmation\n\n### get_identity() -\u003e dict\n- Return current session state\n- Active masque details if donned\n- Previous masque if any\n\n### list_masques() -\u003e dict\n- Return all available masques from both paths\n- Include: name, version, ring, domain, tagline, source\n\n## Session State Format\n\n```yaml\nactive:\n  name: Codesmith\n  source: private  # or shared\n  donned_at: 2026-02-04T12:00:00Z\n  masque: { ... full parsed masque ... }\nprevious:\n  name: null\n  doffed_at: null\n```\n\n## Acceptance\n\n- [ ] don_masque tool works\n- [ ] doff_masque tool works  \n- [ ] get_identity tool works\n- [ ] list_masques tool works\n- [ ] Session persists across MCP restarts","notes":"Not needed - session state via OTEL spans, not MCP tools","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-04T19:40:00.563769-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:25.923158-06:00","closed_at":"2026-02-04T20:34:25.923161-06:00","dependencies":[{"issue_id":"masques-joh","depends_on_id":"masques-2ne","type":"blocks","created_at":"2026-02-04T19:40:08.768296-06:00","created_by":"chris"}]}
{"id":"masques-khb","title":"Implement ring/access checking tools","description":"## Tools\n\n### check_ring(required: str) -\u003e dict\n- Compare active masque's ring level against required\n- Ring hierarchy: admin \u003e player \u003e guest \u003e outsider\n- Return: {allowed: bool, masque_ring: str, required: str}\n\n### get_access_declaration() -\u003e dict\n- Return active masque's access block\n- vault_role, ttl, credentials, capabilities\n- Note: This declares needs, doesn't fulfill them (yet)\n\n## Ring Levels\n\n| Ring | Numeric | Can access |\n|------|---------|------------|\n| admin | 0 | Everything |\n| player | 1 | Normal work |\n| guest | 2 | Read mostly |\n| outsider | 3 | Nothing sensitive |\n\n## Example\n\n```python\n# Masque has ring: player\n\ncheck_ring(\"player\")   # -\u003e {allowed: true}\ncheck_ring(\"guest\")    # -\u003e {allowed: true}  (player \u003e= guest)\ncheck_ring(\"admin\")    # -\u003e {allowed: false} (player \u003c admin)\n```\n\n## Future: Credential Minting\n\nWhen vault integration exists, add:\n- `mint_credential(scope: str, ttl: str) -\u003e dict`\n- Uses masque's vault_role declaration\n- Returns scoped, temporary credential\n\nFor now, just declare and check.\n\n## Acceptance\n\n- [ ] check_ring tool with hierarchy logic\n- [ ] get_access_declaration returns masque's access block\n- [ ] Clear hierarchy comparison","notes":"Ring checks via Witness trace analysis","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-04T19:40:38.469281-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:26.00613-06:00","closed_at":"2026-02-04T20:34:26.006132-06:00","dependencies":[{"issue_id":"masques-khb","depends_on_id":"masques-joh","type":"blocks","created_at":"2026-02-04T19:40:49.601737-06:00","created_by":"chris"}]}
{"id":"masques-o3q","title":"Validate DuckDB JSON path expressions against real collector output","description":"The sessions.sql and score.sql in services/judge/ use JSONPath expressions like \\$[?(@.key==\"skill_name\")].value.stringValue to extract attributes from OTLP JSON. These are best-effort guesses based on the spec — the actual file exporter output structure hasn't been validated. Run the collector, generate real don/doff events, capture the JSONL, and fix the extraction paths to match reality. This is blocking the /performance command from producing accurate scores. Affects services/judge/sessions.sql and services/judge/score.sql.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-06T21:54:05.332459-06:00","created_by":"chris","updated_at":"2026-02-06T22:54:19.042959-06:00","closed_at":"2026-02-06T22:54:19.042959-06:00","close_reason":"Full rewrite of DuckDB scoring pipeline — sessions.sql, score.sql, judge.sh now work with real OTLP data"}
{"id":"masques-p2u","title":"Connect skills to Claude Code skills system","description":"## Problem\n\nMasques declares skills with proficiency levels:\n```yaml\nskills:\n  - uri: skill://programming/zig\n    level: competent\n```\n\nBut these are never connected to Claude Code's actual skills system. They're decorative.\n\n## Options\n\n1. **Remove entirely** - Just write skill guidance into the lens\n2. **Auto-invoke skills** - Masques activates Claude Code skills at don time:\n   ```yaml\n   activates:\n     - compound-engineering:dhh-rails-style\n     - compound-engineering:frontend-design\n   ```\n3. **Skill prerequisites** - `/don` checks if required skills are available, warns if not\n\n## Recommendation\n\nOption 2 - auto-invoke makes masques composable with the skill ecosystem. A Rails masque could automatically invoke dhh-rails-style.\n\n## Acceptance\n\n- [ ] Decide approach\n- [ ] Implement skill activation in `/don`\n- [ ] Update schema\n- [ ] Test with existing Claude Code skills","notes":"Superseded by masques-irl (MCP-based skill activation)","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-04T19:25:30.754362-06:00","created_by":"chris","updated_at":"2026-02-04T19:41:32.509751-06:00","closed_at":"2026-02-04T19:41:32.509753-06:00"}
{"id":"masques-qtr","title":"Implement or remove intent pattern enforcement","description":"## Problem\n\nIntent patterns are defined but never enforced:\n```yaml\nintent:\n  allowed: [\"implement *\", \"design *\"]\n  denied: [\"rush *\", \"ship without tests\"]\n```\n\nThese are displayed in `/inspect` but the agent can freely violate them.\n\n## Options\n\n1. **Remove enforcement expectation** - Keep as documentation/guidance in lens only\n2. **Merge into lens** - Move intent patterns into prose guidance\n3. **Implement enforcement** - Add pattern matching that warns/blocks violations\n\n## Consideration\n\nTrue enforcement is tricky - how do you pattern match against free-form agent actions? This might be better as a post-session evaluation (Witness) rather than real-time blocking.\n\n## Recommendation\n\nMerge into lens. Intent patterns as structured YAML feel like false precision. Better to write \"Never rush, always test\" in the lens.\n\n## Acceptance\n\n- [ ] Decide approach\n- [ ] Implement or migrate\n- [ ] Update schema if removing structured intent\n- [ ] Update existing masques","notes":"Superseded by masques-imo (MCP-based intent enforcement)","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-04T19:25:46.307442-06:00","created_by":"chris","updated_at":"2026-02-04T19:41:32.480568-06:00","closed_at":"2026-02-04T19:41:32.480571-06:00"}
{"id":"masques-vha","title":"Configure masques MCP server in Claude Code","description":"## Goal\n\nMake masques MCP server available to Claude Code sessions.\n\n## Configuration\n\nAdd to ~/.mcp.json or project .mcp.json:\n\n```json\n{\n  \"mcpServers\": {\n    \"masques\": {\n      \"type\": \"stdio\",\n      \"command\": \"uv\",\n      \"args\": [\"run\", \"--directory\", \"~/git/masques/services/mcp-server\", \"masques-mcp\"]\n    }\n  }\n}\n```\n\nOr using npx pattern if published:\n```json\n{\n  \"masques\": {\n    \"type\": \"stdio\", \n    \"command\": \"uvx\",\n    \"args\": [\"masques-mcp\"]\n  }\n}\n```\n\n## Verification\n\n1. Start Claude Code session\n2. Confirm masques tools appear in tool list\n3. Test: call don_masque(\"codesmith\")\n4. Test: call get_identity()\n\n## Local Development\n\nFor development, use local path:\n```json\n{\n  \"masques\": {\n    \"type\": \"stdio\",\n    \"command\": \"uv\",\n    \"args\": [\"run\", \"python\", \"-m\", \"masques_mcp.server\"],\n    \"cwd\": \"/Users/chris/git/masques/services/mcp-server\"\n  }\n}\n```\n\n## Acceptance\n\n- [ ] MCP server config documented\n- [ ] Works with local development setup\n- [ ] Tools accessible in Claude Code\n- [ ] README updated with setup instructions","notes":"No MCP server to configure","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-04T19:41:21.04402-06:00","created_by":"chris","updated_at":"2026-02-04T20:34:26.113399-06:00","closed_at":"2026-02-04T20:34:26.113401-06:00","dependencies":[{"issue_id":"masques-vha","depends_on_id":"masques-2ne","type":"blocks","created_at":"2026-02-04T19:41:25.066901-06:00","created_by":"chris"}]}
