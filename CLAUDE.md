# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Masques is an agent identity framework — "AssumeRole for Agents." A masque is a temporary cognitive identity an agent can don, bundling lens (cognitive framing), context (situational grounding), and attributes (metadata).

**Delivery**: Claude Code plugin that reads YAML masque definitions and injects them into sessions.

## Key Concepts

- **Masques**: Temporary identities with lens, context, and attributes. Session-scoped.
- **Lens**: Cognitive framing that shapes how the agent thinks and works, including boundaries.
- **Context**: Situational grounding — who you're helping, what they value.
- **Versioned Identities**: Masques are pinned to versions; upgrading is deliberate.

## Directory Structure

```
~/.masques/                      # Private masques (user's home)
├── manifest.yaml                # Auto-generated listing cache
├── personal.masque.yaml         # Your private masques here
└── ...

masques/                         # Plugin repo
├── README.md                    # Project overview and quick start
├── CLAUDE.md                    # This file
├── .claude-plugin/
│   └── plugin.json              # Plugin manifest
├── commands/                    # Plugin slash commands
│   ├── don.md                   # /don <masque> - adopt identity
│   ├── doff.md                  # /doff - return to baseline
│   ├── id.md                    # /id - show current identity
│   ├── list.md                  # /list - list masques
│   ├── inspect.md               # /inspect - detailed view
│   ├── sync-manifest.md         # /sync-manifest - regenerate manifests
│   └── audience.md              # /audience - manage telemetry observers
├── personas/                    # Shared masque definitions (YAML source)
│   ├── manifest.yaml            # Auto-generated listing cache
│   ├── codesmith.masque.yaml
│   └── chartwright.masque.yaml
├── schemas/
│   └── masque.schema.yaml       # JSON Schema for masques
└── docs/
    ├── vision.md                # Theater metaphor and philosophy
    ├── concepts.md              # Components explained
    └── schema.md                # Schema reference guide
```

## Plugin Commands

```bash
/don <masque> [intent]    # Adopt a masque identity
/doff                     # Return to baseline Claude
/id                       # Show current identity state
/list                     # List available masques (reads from manifests)
/inspect [masque]         # Detailed masque introspection
/sync-manifest [scope]    # Regenerate manifest files for fast listing
/audience [action]        # Manage telemetry observers (start/stop/status/config/logs)
```

State is persisted in `.claude/masque.session.yaml`.

## Session State

Active masque state is stored in `.claude/masque.session.yaml` (YAML format):

```yaml
# Auto-managed by masques plugin
active:
  name: Codesmith              # null if no masque active
  source: shared               # "private" or "shared"
  donned_at: 2026-01-26T12:00:00Z
previous:
  name: Firekeeper
  source: private
  doffed_at: 2026-01-26T11:00:00Z
```

When doffed, active fields become null and previous fields populate with the doffed masque's info.

**Note:** We store `source` (private/shared) instead of absolute paths to avoid breakage when plugin versions change. The actual path is reconstructed at runtime from name + source.

## Manifests

Masque listings use pre-built manifest files for fast lookups instead of reading every masque file.

**Locations:**
- Private: `~/.masques/manifest.yaml`
- Shared: `personas/manifest.yaml`

**Format:**
```yaml
# Auto-generated by /sync-manifest - do not edit manually
generated_at: 2026-01-26T15:42:00Z
masques:
  - name: Codesmith
    version: "0.1.0"
    domain: systems-programming
    tagline: "every line should teach"
```

**Workflow:**
- Run `/sync-manifest` after adding/modifying masques
- Run `/sync-manifest private` or `/sync-manifest shared` to update only one
- `/list` reads manifests; if missing, prompts to run `/sync-manifest`

## Masque Discovery Paths

Masques are loaded from two locations (in priority order):

1. **Private masques**: `${MASQUES_HOME:-~/.masques}/*.masque.yaml`
   - User's personal masques, stored outside any repo
   - Not version controlled, completely private
   - Configure location with `MASQUES_HOME` env var

2. **Shared masques**: `${CLAUDE_PLUGIN_ROOT}/personas/*.masque.yaml`
   - Bundled with the plugin or shared in projects
   - Version controlled and shareable

If a masque name exists in both locations, the private version takes precedence.

## Creating a New Masque

**For private masques** (personal, not committed):
1. Create `~/.masques/<name>.masque.yaml`
2. Define required fields (see schema below)
3. Test with `/don <name>`

**For shared masques** (project/team):
1. Create `personas/<name>.masque.yaml`
2. Define required fields: `name`, `version`, `lens`
3. Add optional fields: `attributes`, `context`, `spinnerVerbs`
4. Test with `/don <name>`

## Masque Schema (Quick Reference)

```yaml
name: string        # Required. Human-readable name
version: "x.y.z"    # Required. Semantic version

attributes:         # Optional. Flexible metadata
  domain: string
  tagline: string
  style: string
  philosophy: string

context: |          # Optional. Situational framing
  Who you're helping, what they value.

lens: |             # Required. Cognitive framing + intent guidance
  System prompt fragment.
  Include what to do, what to avoid, how to approach work.

spinnerVerbs:       # Optional. Custom activity indicators
  mode: replace     # replace|append|prepend
  verbs:
    - "Masque:Verbing"
```

## Design Principles

1. Simple — lens, context, attributes. That's it.
2. Session-scoped — masques are temporary
3. Versioned — pin to versions, upgrade deliberately
4. Plugin-first — YAML source, Claude Code delivery
