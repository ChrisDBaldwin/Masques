# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Masques is an agent identity framework — "AssumeRole for Agents." A masque is a temporary cognitive identity an agent can don, bundling five components: intent, context, knowledge, access, and lens.

**Delivery**: Claude Code plugin that reads YAML masque definitions and injects them into sessions.

## Key Concepts

- **Masques**: Temporary identities with five components (intent, context, knowledge, access, lens). Session-scoped.
- **MCP Server Bundling**: Masques can define MCP servers that provide domain-specific tools.
- **Knowledge as Pointers**: Masques reference MCP URIs for knowledge lookups, not embedded content.
- **Versioned Identities**: Masques are pinned to versions; upgrading is deliberate.
- **Intent Boundaries**: Glob-style pattern matching for allowed/denied actions.

## Directory Structure

```
~/.masques/                      # Private masques (user's home)
├── manifest.yaml                # Auto-generated listing cache
├── personal.masque.yaml         # Your private masques here
└── ...

masques/                         # Plugin repo
├── README.md                    # Project overview and quick start
├── CLAUDE.md                    # This file
├── .claude-plugin/
│   └── plugin.json              # Plugin manifest
├── commands/                    # Plugin slash commands
│   ├── don.md                   # /don <masque> - adopt identity
│   ├── id.md                    # /id - show current identity
│   ├── list.md                  # /list - list masques
│   ├── inspect.md               # /inspect - detailed view
│   └── sync-manifest.md         # /sync-manifest - regenerate manifests
├── personas/                    # Shared masque definitions (YAML source)
│   ├── manifest.yaml            # Auto-generated listing cache
│   ├── codesmith.masque.yaml
│   └── chartwright.masque.yaml
├── schemas/
│   └── masque.schema.yaml       # JSON Schema for masques
└── docs/
    ├── vision.md                # Theater metaphor and philosophy
    ├── concepts.md              # The five components explained
    └── schema.md                # Schema reference guide
```

## Plugin Commands

```bash
/don <masque> [intent]    # Adopt a masque identity
/id                       # Show current identity state
/list                     # List available masques (reads from manifests)
/inspect [masque]         # Detailed masque introspection
/sync-manifest [scope]    # Regenerate manifest files for fast listing
```

State is persisted in `.claude/masques.local.md`.

## Manifests

Masque listings use pre-built manifest files for fast lookups instead of reading every masque file.

**Locations:**
- Private: `~/.masques/manifest.yaml`
- Shared: `personas/manifest.yaml`

**Format:**
```yaml
# Auto-generated by /sync-manifest - do not edit manually
generated_at: 2026-01-26T15:42:00Z
masques:
  - name: Codesmith
    version: "0.1.0"
    ring: player
    domain: systems-programming
    tagline: "every line should teach"
```

**Workflow:**
- Run `/sync-manifest` after adding/modifying masques
- Run `/sync-manifest private` or `/sync-manifest shared` to update only one
- `/list` reads manifests; if missing, prompts to run `/sync-manifest`

## Masque Discovery Paths

Masques are loaded from two locations (in priority order):

1. **Private masques**: `${MASQUES_HOME:-~/.masques}/*.masque.yaml`
   - User's personal masques, stored outside any repo
   - Not version controlled, completely private
   - Configure location with `MASQUES_HOME` env var

2. **Shared masques**: `${CLAUDE_PLUGIN_ROOT}/personas/*.masque.yaml`
   - Bundled with the plugin or shared in projects
   - Version controlled and shareable

If a masque name exists in both locations, the private version takes precedence.

## Creating a New Masque

**For private masques** (personal, not committed):
1. Create `~/.masques/<name>.masque.yaml`
2. Define required fields (see schema below)
3. Test with `/don <name>`

**For shared masques** (project/team):
1. Create `personas/<name>.masque.yaml`
2. Define required fields: `name`, `index`, `version`, `ring`, `intent`, `lens`
3. Add optional fields: `attributes`, `context`, `knowledge`, `access`, `skills`, `mcp`
4. Test with `/don <name>`

## Masque Schema (Quick Reference)

```yaml
name: string        # Human-readable name
index: integer      # Unique numeric ID
version: "x.y.z"    # Semantic version
ring: player        # admin|player|guest|outsider

attributes:         # Flexible metadata
  domain: string
  tagline: string

intent:             # What this masque can do
  allowed: ["implement *"]
  denied: ["rush *"]

context: |          # Situational framing
  Who you're helping, what they value.

knowledge:          # MCP URIs for lookups
  - mcp://server/resource

access:             # Credential config
  vault_role: role-name
  ttl: session

lens: |             # Cognitive framing
  System prompt fragment.

mcp:                # Optional: bundled MCP servers
  servers:
    - name: server-name
      type: stdio
      command: npx
      args: ["-y", "@package/name"]
```

## Design Principles

1. Intent-driven — every assumption states a goal
2. Session-scoped — masques are temporary
3. Pointer-based — knowledge is looked up, not contained
4. Versioned — pin to versions, upgrade deliberately
5. Plugin-first — YAML source, Claude Code delivery
